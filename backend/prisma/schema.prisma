// schema.prisma

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        Int      @id @default(autoincrement())
  googleSub String   @unique
  email     String   @unique
  name      String?
  avatarUrl String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driveConnections   DriveConnection[]
  youtubeChannelLinks YoutubeChannelLink[]
  uploadJobs          UploadJob[]
  renderJobs          RenderJob[]

  @@index([email])
  @@index([googleSub])
}

model DriveConnection {
  id                String   @id @default(cuid())
  userId            Int
  user              User     @relation(fields: [userId], references: [id])

  driveAccountEmail String
  scopes            String   @db.Text
  status            DriveConnectionStatus @default(ACTIVE)
  lastError         String?  @db.Text

  rootFolderId      String
  rootFolderName    String
  rootFolderLink    String   @db.Text

  accessToken       String?  @db.Text
  refreshToken      String?  @db.Text
  tokenExpiresAt    DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  MediaItems        MediaItem[]
  RenderJobs        RenderJob[]
  UploadJobs        UploadJob[]

  @@index([userId])
  @@index([status])
}

model DriveConsentState {
  state             String   @id
  userId            Int
  nonce             String
  redirectAfter     String?  @db.Text
  requestedFolderId String?
  createdAt         DateTime @default(now())
  expiresAt         DateTime
}

model YoutubeChannel {
  id        Int      @id @default(autoincrement())
  channelId String   @unique
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  links        YoutubeChannelLink[]
  youtubeVideos YoutubeVideo[]
  uploadJobs    UploadJob[]
}

model YoutubeChannelLink {
  id             Int      @id @default(autoincrement())
  userId         Int
  channelId      String

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel        YoutubeChannel @relation(fields: [channelId], references: [channelId], onDelete: Cascade)

  // tokens per user-channel link (use Text to avoid MySQL varchar limits)
  accessToken    String?   @db.Text
  refreshToken   String?   @db.Text
  tokenExpiresAt DateTime?
  scopes         String?   @db.Text

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([userId, channelId])
  @@index([channelId])
  @@index([userId])
}

model MediaItem {
  id             Int      @id @default(autoincrement())
  driveFileId    String   @unique
  name           String
  mimeType       String
  sizeBytes      BigInt?
  folderId       String?
  folderPath     String?  @db.Text
  webViewLink    String?  @db.Text
  webContentLink String?  @db.Text

  driveConnectionId String?
  driveConnection   DriveConnection? @relation(fields: [driveConnectionId], references: [id], onDelete: SetNull)

  status         MediaStatus @default(ACTIVE)

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  youtubeVideos         YoutubeVideo[]
  uploadJobs            UploadJob[]
  audioRenderJobs       RenderJob[]   @relation("AudioMediaItem")
  imageRenderJobs       RenderJob[]   @relation("ImageMediaItem")
  outputRenderJobs      RenderJob[]   @relation("OutputMediaItem")
  thumbnailUploadJobs   UploadJob[]   @relation("ThumbnailMediaItem")
  videoThumbnails       YoutubeVideo[] @relation("VideoThumbnailMediaItem")

  @@index([driveConnectionId])
}

model YoutubeVideo {
  id                 Int            @id @default(autoincrement())
  mediaItemId        Int
  mediaItem          MediaItem      @relation(fields: [mediaItemId], references: [id], onDelete: Restrict)

  youtubeChannelId   Int
  youtubeChannel     YoutubeChannel @relation(fields: [youtubeChannelId], references: [id], onDelete: Restrict)

  thumbnailMediaItemId Int?
  thumbnailMediaItem   MediaItem?   @relation("VideoThumbnailMediaItem", fields: [thumbnailMediaItemId], references: [id], onDelete: SetNull)

  youtubeVideoId     String?        @unique

  title              String
  description        String         @db.Text
  tags               String?        @db.Text
  privacyStatus      PrivacyStatus
  publishAt          DateTime?

  status             VideoStatus    @default(PUBLISHED)

  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  uploadJobs         UploadJob[]

  @@index([mediaItemId])
  @@index([youtubeChannelId])
  @@index([thumbnailMediaItemId])
}

model UploadJob {
  id                  Int            @id @default(autoincrement())
  mediaItemId         Int
  mediaItem           MediaItem      @relation(fields: [mediaItemId], references: [id], onDelete: Restrict)

  youtubeChannelId    Int
  youtubeChannel      YoutubeChannel @relation(fields: [youtubeChannelId], references: [id], onDelete: Restrict)

  requestedByUserId   Int
  requestedByUser     User           @relation(fields: [requestedByUserId], references: [id], onDelete: Restrict)

  youtubeVideoId      Int?
  youtubeVideo        YoutubeVideo?  @relation(fields: [youtubeVideoId], references: [id], onDelete: SetNull)

  thumbnailMediaItemId Int?
  thumbnailMediaItem   MediaItem?    @relation("ThumbnailMediaItem", fields: [thumbnailMediaItemId], references: [id], onDelete: SetNull)

  driveConnectionId  String?
  driveConnection    DriveConnection? @relation(fields: [driveConnectionId], references: [id], onDelete: SetNull)

  title               String
  description         String         @db.Text
  tags                String?        @db.Text
  privacyStatus       PrivacyStatus
  scheduledFor        DateTime?

  status              JobStatus      @default(PENDING)
  errorMessage        String?        @db.Text

  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@index([mediaItemId])
  @@index([youtubeChannelId])
  @@index([requestedByUserId])
  @@index([youtubeVideoId])
  @@index([thumbnailMediaItemId])
  @@index([driveConnectionId])
  @@index([status, scheduledFor])
}

model RenderJob {
  id               Int      @id @default(autoincrement())

  renderSpec String @db.Text
  audioMediaItemId Int
  audioMediaItem   MediaItem  @relation("AudioMediaItem", fields: [audioMediaItemId], references: [id], onDelete: Restrict)

  imageMediaItemId Int?
  imageMediaItem   MediaItem? @relation("ImageMediaItem", fields: [imageMediaItemId], references: [id], onDelete: SetNull)

  outputMediaItemId Int?
  outputMediaItem   MediaItem? @relation("OutputMediaItem", fields: [outputMediaItemId], references: [id], onDelete: SetNull)

  requestedByUserId Int?
  requestedByUser   User?     @relation(fields: [requestedByUserId], references: [id], onDelete: SetNull)

  driveConnectionId String?
  driveConnection   DriveConnection? @relation(fields: [driveConnectionId], references: [id], onDelete: SetNull)

  waveformConfig   String?   @db.Text

  status           JobStatus @default(PENDING)
  errorMessage     String?   @db.Text

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([audioMediaItemId])
  @@index([imageMediaItemId])
  @@index([outputMediaItemId])
  @@index([requestedByUserId])
  @@index([driveConnectionId])
  @@index([status])
}

enum MediaStatus {
  ACTIVE
  MISSING
  DELETED
}

enum VideoStatus {
  PUBLISHED
  SCHEDULED
}

enum JobStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum PrivacyStatus {
  PUBLIC
  UNLISTED
  PRIVATE
}

enum DriveConnectionStatus {
  ACTIVE
  ERROR
  REVOKED
}
